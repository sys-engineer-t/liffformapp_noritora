<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トランポリンハウスNORIxNORI 会員証</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
</head>
<body>
    <p id="liff-message"></p>
    <p id="liff-message2"></p>
    <span id="area"></span>
    <!--
        <div style="border-style: double;margin: 10px;padding: 10px;">
        <div style="background-color: #99FF99;">
        <h6><div style="text-align: center;font-family:Comic Sans MS;font-weight:bold;">トランポリンハウスNORI×NORI</div></h6>
        <div class="" style="text-align: center;">会員番号：■</div>
        </div>
        </div>
    -->
    <!--
    <form class="w-75 mx-auto">  
        
        <p class="mt-3">氏名(漢字)</p>
        <div>
            <input class="form-control w-100 mt-1" name="name" required>
        </div>
        <p class="mt-3">会員番号</p>
        <div>
            <input class="form-control w-100 mt-1" name="no" placeholder="会員証の番号を入力" required>
        </div>
        <input type="submit" class="mt-4 btn btn-primary" value="登録">
    </form>
    -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script>
        const endpoint = "https://script.google.com/macros/s/AKfycbyrce0GVy3CQkfryPmTlAT-DPc8iwdoMF9mEFvf_D3Kmkk1EeSlNIa-k06z7d5pv16B/exec";

        $(document).ready(function () {
            const liffId = "1657758889-bBMyjVOA";
            var lineiId = "";            
            const divPage = document.getElementById('liff-page');
            
            //p要素の取得
            const pElement = document.getElementById('liff-message');
                      
            //LIFFで立ち上げているかどうかの判定
            if(liff.isInClient()){
              pElement.innerHTML='読み込み中...'
              

              //LIFF初期化
              liff.init({
                liffId: liffId
              })
              .then(()=>{
                //プロフィール情報の取得
                liff.getProfile()
                .then(profile=>{
                  lineId = profile.userId;
                })
                .then(()=>{
                  //document.body.innerHTML = 'aaaa id' + lineId    
                  ajaxConn(lineId);
                })
                .catch((err) => {
                   alert('error');   
                })
              })
              .catch((err) => {
                console.log('LIFF Initialization failed ', err);
              });
            }else{
              //doument.body.innerHTML = 'LINEで開いてください'
            }
            
        })

        function ajaxConn(lineId){
                    $.ajax({
                        type: 'GET',
                        url: endpoint,
                        dataType: 'jsonp',
                        data: {
                          text: lineId
                        },
                        success: out => {
                          alert(out.rslt);  
                          if(out.rslt=="###"){
                             document.getElementById('liff-message') = '';
                             document.getElementById("area").innerHTML = '<form class="w-75 mx-auto"><p id="liff-message"></p><p id="liff-message2"></p><p class="mt-3">氏名(漢字)</p><div><input class="form-control w-100 mt-1" name="name" required></div><p class="mt-3">会員番号</p><div><input class="form-control w-100 mt-1" name="no" placeholder="会員証の番号を入力" required></div><input type="submit" class="mt-4 btn btn-primary" value="登録"></form>';
                          }else{
                             document.getElementById('liff-message') = '初回登録設定画面';
                             document.body.style.backgroundColor = "#99FF99";
                             var str1 = '<div style="border-style: double;margin: 30% 15%; padding: 5%;"><div style="background-color: #99FF99;"><h5><div style="text-align: center;font-family:Comic Sans MS;font-weight:bold;">トランポリンハウスNORI×NORI</div></h5><div class="" style="text-align: center; margin-top: 5%;">会員番号：'
                             var str2 = '</div></div></div>'
                             document.getElementById("area").innerHTML = str1 + out.rslt + str2
                          }
                        },
                        error: function(){
                          document.body.innerHTML = ''
                          alert("通信エラー");
                        }
                    });   
        }
        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((err) => {
                console.log('LIFF Initialization failed ', err);
            });
        }

        function sendText(text) {
            liff.sendMessages([{
                'type': 'text',
                'text': text
            }]).then(function () {
                liff.closeWindow();
            }).catch(function (error) {
                window.alert('Failed to send message ' + error);
            });
        }

        function createData(text){
            window.close();
            alert("登録完了しました");
        }
        const params = (new URL(document.location)).searchParams;
        const key = params.get('key');

        $(function () {
            $('form').submit(function () {
                const name    = $('input[name="name"]').val();
                const no = $('input[name="no"]').val();
                if (!no.match(/^[0-9]+$/)) {
                  //半角数値
                  window.alert('会員番号は半角数値で入力してください');
                  return false;
                }
                const msg = '${name}\n${no}';
                if(window.confirm('氏名(漢字)：'+name+'\n会員番号：'+no+'\n\nこの内容で間違いないですか？')){
                  createData(msg);
                }
                return false;
            });
        });

    </script>

</body>
</html>
